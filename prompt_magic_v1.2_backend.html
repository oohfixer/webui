<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Magic</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');
        
        :root {
            --bg: transparent;
            --text-primary: #fff;
            --text-secondary: rgba(255,255,255,.7);
            --text-muted: rgba(255,255,255,.4);
            --glass-bg: rgba(255,255,255,.02);
            --glass-border: rgba(255,255,255,.08);
            --glass-focus: rgba(255,255,255,.12);
            --blur: blur(20px);
            --transition: all .4s cubic-bezier(.23,1,.32,1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-weight: 300;
        }

        #cxChat {
            position: relative;
            width: 480px;
            height: 700px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: var(--transition);
            opacity: 0;
            transform: translateY(20px);
            animation: chatAppear 1.5s .5s cubic-bezier(.23,1,.32,1) forwards;
        }

        @keyframes chatAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #cxChat.free-limit {
            border-color: rgba(255,255,255,.2);
            transform: translateY(-5px);
            box-shadow: 0 20px 60px rgba(0,0,0,.4);
        }

        header {
            position: relative;
            padding: 30px 30px 20px;
            border-bottom: 1px solid var(--glass-border);
            opacity: 0;
            animation: headerSlide 1s 1s cubic-bezier(.23,1,.32,1) forwards;
        }

        @keyframes headerSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 20px;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-layers {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .logo-layers .layer {
            position: absolute;
            inset: 0;
            border: 1px solid rgba(255,255,255,.3);
            border-radius: 8px;
            transform-origin: center;
            transition: var(--transition);
        }

        .logo-layers .layer:nth-child(1) {
            transform: rotate(0deg);
            animation: layerRotate1 8s linear infinite;
        }

        .logo-layers .layer:nth-child(2) {
            transform: rotate(45deg);
            animation: layerRotate2 12s linear infinite reverse;
        }

        .logo-layers .layer:nth-child(3) {
            transform: rotate(90deg);
            animation: layerRotate3 10s linear infinite;
        }

        @keyframes layerRotate1 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes layerRotate2 {
            from { transform: rotate(45deg); }
            to { transform: rotate(405deg); }
        }

        @keyframes layerRotate3 {
            from { transform: rotate(90deg); }
            to { transform: rotate(450deg); }
        }

        .title-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 100;
            background: linear-gradient(180deg, #fff 0%, rgba(255,255,255,.6) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -.02em;
            line-height: 1;
        }

        .subtitle {
            font-size: .9rem;
            font-weight: 300;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            background: rgba(255,255,255,.04);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            font-size: .8rem;
            font-weight: 300;
            color: #4caf50;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .status-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: rgba(76, 175, 80, 0.8);
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% {
                opacity: .4;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        main {
            flex: 1;
            position: relative;
            padding: 30px 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
            opacity: 0;
            animation: mainFade 1s 1.5s ease forwards;
        }

        @keyframes mainFade {
            to { opacity: 1; }
        }

        .msg {
            max-width: 85%;
            padding: 20px 24px;
            border-radius: 16px;
            line-height: 1.6;
            font-size: .95rem;
            font-weight: 300;
            position: relative;
            word-wrap: break-word;
            opacity: 0;
            transform: translateY(15px);
            animation: messageSlideIn .8s cubic-bezier(.23,1,.32,1) forwards;
        }

        .msg.user {
            margin-left: auto;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.1);
            backdrop-filter: var(--blur);
            color: var(--text-primary);
        }

        .msg.bot {
            margin-right: auto;
            background: rgba(255,255,255,.03);
            border: 1px solid rgba(255,255,255,.06);
            backdrop-filter: var(--blur);
            color: var(--text-secondary);
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing {
            width: 60px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 4px;
            margin: 16px 0;
            padding: 0 24px;
        }

        .typing div {
            width: 3px;
            height: 8px;
            background: rgba(255,255,255,.4);
            border-radius: 2px;
            animation: typingPulse 1.2s infinite ease-in-out;
        }

        .typing div:nth-child(1) { animation-delay: 0s; }
        .typing div:nth-child(2) { animation-delay: .2s; }
        .typing div:nth-child(3) { animation-delay: .4s; }

        @keyframes typingPulse {
            0%, 100% {
                transform: scaleY(1);
                opacity: .4;
            }
            50% {
                transform: scaleY(1.5);
                opacity: 1;
            }
        }

        footer {
            position: relative;
            padding: 30px 40px 40px;
            border-top: 1px solid var(--glass-border);
            opacity: 0;
            animation: footerSlide 1s 2s cubic-bezier(.23,1,.32,1) forwards;
        }

        @keyframes footerSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
            height: 56px;
        }

        .input-bg {
            position: absolute;
            inset: 0;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            backdrop-filter: var(--blur);
            transition: var(--transition);
        }

        .input-wrapper:focus-within .input-bg {
            background: var(--glass-focus);
            border-color: rgba(255,255,255,.2);
            transform: translateY(-1px);
        }

        .input-wrapper.glow .input-bg {
            border-color: rgba(255,255,255,.3);
            background: var(--glass-focus);
        }

        .input-wrapper input {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            padding: 0 24px;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: .95rem;
            font-weight: 300;
            font-family: inherit;
            transition: var(--transition);
        }

        .input-wrapper input::placeholder {
            color: var(--text-muted);
            font-weight: 300;
        }

        .input-shimmer {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.1) 50%, transparent 100%);
            border-radius: 12px;
            pointer-events: none;
            transition: left .6s ease;
        }

        .input-wrapper:focus-within .input-shimmer {
            left: 100%;
        }

        .send-btn {
            position: relative;
            width: 56px;
            height: 56px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            overflow: hidden;
        }

        .btn-bg {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,.06);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            backdrop-filter: var(--blur);
            transition: var(--transition);
        }

        .send-btn:hover .btn-bg {
            background: rgba(255,255,255,.1);
            border-color: rgba(255,255,255,.2);
            transform: translateY(-1px);
        }

        .send-btn:active {
            transform: scale(.95);
        }

        .btn-icon {
            position: relative;
            z-index: 2;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .send-btn:hover .btn-icon {
            transform: translateX(2px);
        }

        .free-limit-modal {
            position: absolute;
            inset: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity .6s cubic-bezier(.23,1,.32,1);
        }

        .free-limit-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.8);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            position: relative;
            z-index: 2;
            background: rgba(255,255,255,.02);
            backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
            max-width: 360px;
            transform: translateY(20px);
            animation: modalSlide .6s .2s cubic-bezier(.23,1,.32,1) forwards;
        }

        @keyframes modalSlide {
            to { transform: translateY(0); }
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 24px;
            opacity: .8;
        }

        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: 200;
            margin-bottom: 16px;
            background: linear-gradient(180deg, #fff 0%, rgba(255,255,255,.7) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -.01em;
        }

        .modal-content p {
            color: var(--text-secondary);
            font-size: .95rem;
            font-weight: 300;
            line-height: 1.5;
            margin-bottom: 40px;
        }

        .cta-button {
            position: relative;
            width: 100%;
            height: 52px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: .9rem;
            font-weight: 300;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            overflow: hidden;
            transition: var(--transition);
            font-family: inherit;
            border-radius: 12px;
        }

        .cta-button::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,.06);
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--blur);
            transition: var(--transition);
            border-radius: 12px;
        }

        .cta-button:hover::before {
            background: rgba(255,255,255,.1);
            border-color: rgba(255,255,255,.2);
            transform: translateY(-2px);
        }

        .cta-button span {
            position: relative;
            z-index: 2;
        }

        .cta-glow {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.1) 50%, transparent 100%);
            transform: translateX(-100%);
            transition: transform .6s ease;
            border-radius: 12px;
        }

        .cta-button:hover .cta-glow {
            transform: translateX(100%);
        }

        main::-webkit-scrollbar {
            width: 2px;
        }

        main::-webkit-scrollbar-track {
            background: transparent;
        }

        main::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,.2);
            border-radius: 1px;
        }

        main::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,.3);
        }

        @media(max-width: 768px) {
            body {
                padding: 20px 10px;
            }

            #cxChat {
                width: 100%;
                max-width: 400px;
                height: 600px;
            }

            header {
                padding: 30px 25px 20px;
            }

            .title {
                font-size: 2rem;
            }

            main {
                padding: 20px 25px;
                gap: 15px;
            }

            footer {
                padding: 20px 25px 30px;
            }

            .msg {
                padding: 16px 20px;
                font-size: .9rem;
            }

            .modal-content {
                padding: 40px 30px;
                max-width: 300px;
                margin: 0 20px;
            }
        }

        @media(max-width: 480px) {
            .title {
                font-size: 1.8rem;
            }

            .input-container {
                gap: 10px;
            }

            .input-wrapper input {
                padding: 0 20px;
                font-size: .9rem;
            }

            .send-btn {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div id="cxChat">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo-icon">
                        <div class="logo-layers">
                            <div class="layer"></div>
                            <div class="layer"></div>
                            <div class="layer"></div>
                        </div>
                    </div>
                    <div class="title-group">
                        <span class="title">Prompt Magic</span>
                        <span class="subtitle">AI Creative Suite</span>
                    </div>
                </div>
                <div class="status-badge">
                    <div class="status-dot"></div>
                    <span>Live</span>
                </div>
            </div>
        </header>
        <main id="cxMsgs"></main>
        <footer>
            <div class="input-container">
                <div class="input-wrapper" id="inputWrapper">
                    <div class="input-bg"></div>
                    <input id="cxInput" type="text" autocomplete="off" placeholder="Describe your creative vision...">
                    <div class="input-shimmer"></div>
                </div>
                <button id="cxSend" class="send-btn">
                    <div class="btn-bg"></div>
                    <div class="btn-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                        </svg>
                    </div>
                </button>
            </div>
        </footer>
        <div class="free-limit-modal" id="cta">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="modal-icon">‚ú®</div>
                <h3>Ready for More Magic?</h3>
                <p>You've experienced the power. Continue your creative journey.</p>
                <button id="startMore" class="cta-button">
                    <span>Start New Session</span>
                    <div class="cta-glow"></div>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Updated for your Vercel backend
        const CONFIG = {
            BACKEND_URL: 'https://magicprompt-dfmsx61hd-stevens-projects-86ae5ecb.vercel.app'
        };

        // DOM elements
        const messagesContainer = document.getElementById("cxMsgs");
        const sendButton = document.getElementById("cxSend");
        const chatContainer = document.getElementById("cxChat");
        const inputWrapper = document.getElementById("inputWrapper");
        const ctaModal = document.getElementById("cta");

        // State variables
        let currentInput;
        let userResponses = [];
        let messageIndex = 0;
        let sessionId = generateSessionId();

        // Messages
        const welcomeMessages = [
            "‚ú® Welcome to Prompt Magic ‚Äì where creativity meets AI precision.",
            "I'm your creative AI partner. Share your first vision and let's craft something extraordinary."
        ];

        const followUpMessages = [
            "Brilliant! Your creative energy is flowing. What's your next inspiration?",
            "Excellent direction ‚Äì I can feel the creative momentum. Give me your third concept.",
            "Perfect! You're building something remarkable. What's your fourth creative spark?",
            "Outstanding! One more piece to complete your creative puzzle ‚Äì what's the fifth?"
        ];

        // Utility functions
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getTodaysRuns() {
            const runs = JSON.parse(localStorage.getItem("pm_runs") || "[]");
            const today = Date.now();
            return runs.filter(timestamp => today - timestamp < 24 * 60 * 60 * 1000);
        }

        function addRunToday() {
            const runs = getTodaysRuns();
            runs.push(Date.now());
            localStorage.setItem("pm_runs", JSON.stringify(runs));
        }

        function hasEmail() {
            return !!localStorage.getItem("pm_email");
        }

        // Backend communication
        async function sendToBackend(endpoint, data) {
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/api/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...data,
                        sessionId: sessionId,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        referrer: document.referrer || 'direct'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Backend request failed');
                }
                
                return result;
                
            } catch (error) {
                console.error('Backend error:', error);
                return { success: false, error: error.message };
            }
        }

        // Email handling
        async function saveEmail(email) {
            localStorage.setItem("pm_email", email);
            
            // Send email to backend
            const result = await sendToBackend('collect-email', {
                email: email,
                source: 'prompt_magic_chat',
                pageUrl: window.location.href
            });

            if (result.success) {
                console.log('‚úÖ Email saved successfully');
            } else {
                console.warn('‚ö†Ô∏è Email save failed:', result.error);
            }

            inputWrapper.classList.remove("glow");
            setupMessageInput();
            addBotMessage("üéØ Email secured! Your creative journey continues. Ready for another session?");
        }

        function showEmailInput() {
            inputWrapper.innerHTML = `
                <div class="input-bg"></div>
                <input id="emailInput" type="email" placeholder="Enter your email to unlock more magic...">
                <div class="input-shimmer"></div>
            `;
            inputWrapper.classList.add("glow");
            const emailInput = document.getElementById("emailInput");
            emailInput.focus();
            emailInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && e.target.value.trim()) {
                    saveEmail(e.target.value.trim());
                }
            });
        }

        function setupMessageInput() {
            inputWrapper.innerHTML = `
                <div class="input-bg"></div>
                <input id="cxInput" type="text" autocomplete="off" placeholder="Describe your creative vision...">
                <div class="input-shimmer"></div>
            `;
            inputWrapper.classList.remove("glow");
            currentInput = document.getElementById("cxInput");
            currentInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });
        }

        // Message handling
        function addMessage(type, content) {
            const messageElement = document.createElement("div");
            messageElement.className = "msg " + type;
            messageElement.innerHTML = `<span>${content}</span>`;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function createTypingIndicator() {
            const typingElement = document.createElement("div");
            typingElement.className = "msg bot typing";
            typingElement.innerHTML = "<div></div><div></div><div></div>";
            messagesContainer.appendChild(typingElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return typingElement;
        }

        function addBotMessage(content, callback = null, delay = 1500) {
            const typingIndicator = createTypingIndicator();
            setTimeout(() => {
                typingIndicator.remove();
                addMessage("bot", content);
                if (callback) callback();
            }, delay);
        }

        // Main message handling
        function sendMessage() {
            const message = currentInput.value.trim();
            if (!message) return;

            // Check if user has hit daily limit
            if (getTodaysRuns().length >= 3) {
                addBotMessage("üöÄ You've unlocked the full Prompt Magic experience! Ready to create something legendary?");
                chatContainer.classList.add("free-limit");
                ctaModal.classList.add("show");
                return;
            }

            addMessage("user", message);
            currentInput.value = "";
            userResponses.push(message);

            // Handle welcome flow
            if (messageIndex < welcomeMessages.length - 1) {
                messageIndex++;
                addBotMessage(welcomeMessages[messageIndex]);
                return;
            }

            // Handle follow-up questions
            if (userResponses.length <= followUpMessages.length) {
                addBotMessage(followUpMessages[userResponses.length - 1]);
                return;
            }

            // After 5 responses, process the prompt
            addRunToday();

            if (getTodaysRuns().length === 1 && !hasEmail()) {
                addBotMessage("üé® Your creative blueprint is being processed...", () => {
                    addBotMessage("To continue crafting magic, I'll need your email:", showEmailInput);
                });
                return;
            }

            addBotMessage("‚ú® Your creative vision is being transformed into pure magic...", processPrompt);
            chatContainer.classList.add("free-limit");
            ctaModal.classList.add("show");
        }

        // Process prompt with backend
        async function processPrompt() {
            const promptData = {
                responses: userResponses.map((response, index) => ({
                    question: `Creative Vision ${index + 1}`,
                    answer: response,
                    questionIndex: index
                })),
                email: localStorage.getItem("pm_email") || 'anonymous',
                completedAt: new Date().toISOString(),
                source: 'prompt_magic_chat'
            };

            const result = await sendToBackend('process-prompt', promptData);

            if (result.success) {
                console.log('‚úÖ Prompt processed successfully');
                
                // Show the generated prompt if available
                if (result.generated_prompt || result.data?.generated_prompt) {
                    const generatedPrompt = result.generated_prompt || result.data.generated_prompt;
                    addBotMessage(`üéØ Your personalized prompt is ready:\n\n${generatedPrompt}`);
                }
            } else {
                console.warn('‚ö†Ô∏è Prompt processing failed:', result.error);
                addBotMessage("‚ú® Your creative magic has been captured and will be processed shortly!");
            }
        }

        // Event listeners
        sendButton.addEventListener("click", sendMessage);

        document.getElementById("startMore").addEventListener("click", () => {
            location.reload();
        });

        // Initialize the app
        window.addEventListener("load", () => {
            setupMessageInput();
            addBotMessage(welcomeMessages[0], () => {
                addBotMessage(welcomeMessages[1]);
            });
            
            // Test backend connectivity
            fetch(`${CONFIG.BACKEND_URL}/api/health`)
                .then(response => {
                    if (response.ok) {
                        console.log('‚úÖ Backend connected successfully');
                    } else {
                        throw new Error('Backend not responding');
                    }
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è Backend connection issue:', error);
                });
        });
    </script>
</body>
</html>